name: CI
on:
  push:
  workflow_dispatch:
jobs:
  puppeteer:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js v18.14.2
        uses: actions/setup-node@v3
        with:
          node-version: 18.14.2

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        env:
          PUPPETEER_SKIP_DOWNLOAD: true
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-xcb1 libxtst6 libxss1 libgconf-2-4 libnss3 libasound2 xvfb
          yarn install
          git submodule init
          git submodule update

      - name: (Port Docker) Install dependencies
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
        run: |
          # See https://crbug.com/795759
          # Install latest chrome dev package, which installs the necessary libs to make the bundled version of Chromium that Puppeteer installs work.
          sudo apt-get install -yq libgconf-2-4
          sudo apt-get install -y wget xvfb --no-install-recommends
          sudo wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable --no-install-recommends
          sudo rm -rf /var/lib/apt/lists/*

      - name: Start Xvfb
        run: Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Install Chrome r1095492
        run: |
          wget https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2F1095492%2Fchrome-linux.zip?alt=media -O chrome.zip
          unzip chrome.zip

      - name: Start Chrome
        run: |
          ./chrome-linux/chrome --remote-debugging-port=9222 http://localhost &
          # ./chrome-linux/chrome --no-sandbox --headless --disable-gpu --remote-debugging-port=9222 http://localhost &

      - name: Run scraper
        run: |
          yarn start:no-sandbox https://uad.ubq.fi/
        env:
          DISPLAY: ":99"
